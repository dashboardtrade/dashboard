<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Gemini AI Trading Bot - Complete Professional Chart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- TradingView Advanced Charts -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <style>
        body { 
            background: #0b1426; 
            color: #ffffff; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar { background: #1e2329 !important; border-bottom: 1px solid #2b3139; }
        .card { 
            background: #1e2329; 
            border: 1px solid #2b3139; 
            border-radius: 8px;
        }
        .card-header { 
            background: #2b3139; 
            border-bottom: 1px solid #3c4043; 
            font-weight: 600;
        }
        .text-success { color: #4bffb5 !important; }
        .text-danger { color: #ff4976 !important; }
        .bg-success { background-color: #4bffb5 !important; }
        .bg-danger { background-color: #ff4976 !important; }
        .table-dark { 
            background: #1e2329; 
            border-color: #2b3139;
        }
        .table-dark td, .table-dark th { 
            border-color: #2b3139; 
            color: #ffffff;
        }
        .metric-card {
            background: linear-gradient(135deg, #1e2329 0%, #2b3139 100%);
            border: 1px solid #3c4043;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .metric-label {
            color: #848e9c;
            font-size: 0.9rem;
        }
        #tradingview_complete {
            height: 600px;
            background: #1e2329;
            border-radius: 8px;
        }
        .custom-toolbar {
            background: #2b3139;
            padding: 8px 15px;
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #3c4043;
        }
        .indicator-btn {
            background: #3c4043;
            border: 1px solid #485c7b;
            color: #d1d4dc;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 8px;
            cursor: pointer;
        }
        .indicator-btn:hover {
            background: #485c7b;
            color: white;
        }
        .indicator-btn.active {
            background: #f0b90b;
            color: #000;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot me-2"></i>
                Gemini AI Trading Bot - Complete Professional Chart
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-circle text-success me-1"></i>
                    Full Professional Trading Platform
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Metrics Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value text-warning" id="currentPrice">$0</div>
                    <div class="metric-label">BTC/USD Price</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value text-info" id="totalTrades">0</div>
                    <div class="metric-label">Total Trades</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value text-success" id="winRate">0%</div>
                    <div class="metric-label">Win Rate</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="totalPnL">$0.00</div>
                    <div class="metric-label">Total P&L</div>
                </div>
            </div>
        </div>

        <!-- Chart and Trades Row -->
        <div class="row">
            <!-- Complete Professional Chart -->
            <div class="col-lg-8">
                <div class="card">
                    <!-- Custom Indicator Toolbar -->
                    <div class="custom-toolbar">
                        <div class="d-flex align-items-center flex-wrap">
                            <span class="me-3"><i class="fas fa-chart-line me-2"></i>Professional Chart</span>
                            
                            <!-- Indicators -->
                            <div class="me-4">
                                <button class="indicator-btn active" onclick="dashboard.toggleIndicator('volume')">
                                    <i class="fas fa-chart-bar me-1"></i>Volume
                                </button>
                                <button class="indicator-btn" onclick="dashboard.toggleIndicator('macd')">
                                    <i class="fas fa-wave-square me-1"></i>MACD
                                </button>
                                <button class="indicator-btn" onclick="dashboard.toggleIndicator('rsi')">
                                    <i class="fas fa-chart-area me-1"></i>RSI
                                </button>
                            </div>
                            
                            <!-- Trade Level Plotting -->
                            <div>
                                <button class="indicator-btn" onclick="dashboard.plotTradeLevels('entry')">
                                    <i class="fas fa-crosshairs me-1"></i>Plot Entries
                                </button>
                                <button class="indicator-btn" onclick="dashboard.plotTradeLevels('sl')">
                                    <i class="fas fa-times me-1"></i>Plot SL
                                </button>
                                <button class="indicator-btn" onclick="dashboard.plotTradeLevels('tp')">
                                    <i class="fas fa-bullseye me-1"></i>Plot TP
                                </button>
                                <button class="indicator-btn" onclick="dashboard.plotTradeLevels('all')">
                                    <i class="fas fa-layer-group me-1"></i>Plot All
                                </button>
                                <button class="indicator-btn" onclick="dashboard.clearTradePlots()">
                                    <i class="fas fa-eraser me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="tradingview_complete"></div>
                    </div>
                </div>
            </div>

            <!-- Recent Trades -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-exchange-alt me-2"></i>
                            Recent Trades
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-dark table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Price</th>
                                        <th>P&L</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="trades-table">
                                    <tr>
                                        <td colspan="4" class="text-center">Loading trades...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        class CompleteTradingDashboard {
            constructor() {
                this.widget = null;
                this.trades = [];
                this.activeIndicators = new Set(['volume']);
                this.init();
            }

            init() {
                this.setupCompleteChart();
                this.loadData();
                
                // Update every 30 seconds
                setInterval(() => {
                    this.loadData();
                }, 30000);
            }

            setupCompleteChart() {
                // TradingView with BOTH drawing tools AND custom indicator controls
                this.widget = new TradingView.widget({
                    width: '100%',
                    height: 600,
                    symbol: "BINANCE:BTCUSDT",
                    interval: "1",
                    timezone: "Etc/UTC",
                    theme: "dark",
                    style: "1",
                    locale: "en",
                    enable_publishing: false,
                    hide_top_toolbar: false,
                    hide_legend: false,
                    hide_side_toolbar: false,
                    allow_symbol_change: true,
                    save_image: true,
                    container_id: "tradingview_complete",
                    studies: ["Volume@tv-basicstudies"],
                    overrides: {
                        "paneProperties.background": "#1e2329",
                        "mainSeriesProperties.candleStyle.upColor": "#4bffb5",
                        "mainSeriesProperties.candleStyle.downColor": "#ff4976"
                    }
                });

                console.log('Complete Professional Chart initialized');
            }

            toggleIndicator(indicator) {
                const btn = event.target.closest('.indicator-btn');
                
                if (this.activeIndicators.has(indicator)) {
                    // Remove indicator
                    this.activeIndicators.delete(indicator);
                    btn.classList.remove('active');
                } else {
                    // Add indicator
                    this.activeIndicators.add(indicator);
                    btn.classList.add('active');
                }
                
                this.updateIndicators();
            }

            updateIndicators() {
                // Recreate widget with new indicators
                const studies = [];
                
                if (this.activeIndicators.has('volume')) studies.push("Volume@tv-basicstudies");
                if (this.activeIndicators.has('macd')) studies.push("MACD@tv-basicstudies");
                if (this.activeIndicators.has('rsi')) studies.push("RSI@tv-basicstudies");
                if (this.activeIndicators.has('bb')) studies.push("BB@tv-basicstudies");

                // Update widget with new studies
                this.widget = new TradingView.widget({
                    width: '100%',
                    height: 600,
                    symbol: "BINANCE:BTCUSDT",
                    interval: "1",
                    timezone: "Etc/UTC",
                    theme: "dark",
                    style: "1",
                    locale: "en",
                    enable_publishing: false,
                    hide_top_toolbar: false,
                    hide_legend: false,
                    hide_side_toolbar: false,
                    allow_symbol_change: true,
                    save_image: true,
                    container_id: "tradingview_complete",
                    studies: studies,
                    overrides: {
                        "paneProperties.background": "#1e2329",
                        "mainSeriesProperties.candleStyle.upColor": "#4bffb5",
                        "mainSeriesProperties.candleStyle.downColor": "#ff4976"
                    }
                });

                console.log('Updated indicators:', Array.from(this.activeIndicators));
            }

            async loadData() {
                try {
                    await Promise.all([
                        this.loadTrades(),
                        this.loadStats(),
                        this.loadCurrentPrice()
                    ]);
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            }

            async loadCurrentPrice() {
                try {
                    const response = await fetch('/api/candles');
                    const data = await response.json();
                    
                    if (data.candles && data.candles.length > 0) {
                        const latestCandle = data.candles[data.candles.length - 1];
                        document.getElementById('currentPrice').textContent = '$' + latestCandle.c.toLocaleString();
                    }
                } catch (error) {
                    console.error('Error loading current price:', error);
                }
            }

            async loadTrades() {
                try {
                    const response = await fetch('/api/trades');
                    const data = await response.json();
                    this.trades = data.trades || [];
                    
                    const tradesTable = document.getElementById('trades-table');
                    if (this.trades.length > 0) {
                        tradesTable.innerHTML = this.trades.slice(0, 25).map(trade => `
                            <tr>
                                <td>
                                    <span class="badge ${trade.direction === 'long' ? 'bg-success' : 'bg-danger'}">
                                        ${trade.direction.toUpperCase()}
                                    </span>
                                </td>
                                <td>$${trade.entry_price}</td>
                                <td class="${(trade.pnl || 0) >= 0 ? 'text-success' : 'text-danger'}">
                                    ${(trade.pnl || 0) >= 0 ? '+' : ''}$${(trade.pnl || 0).toFixed(2)}
                                </td>
                                <td class="text-muted small">
                                    ${new Date(trade.timestamp).toLocaleTimeString()}
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tradesTable.innerHTML = '<tr><td colspan="4" class="text-center">No trades yet</td></tr>';
                    }
                } catch (error) {
                    console.error('Error loading trades:', error);
                }
            }

            async loadStats() {
                try {
                    const response = await fetch('/api/stats');
                    const data = await response.json();
                    
                    document.getElementById('totalTrades').textContent = data.totalTrades || 0;
                    document.getElementById('winRate').textContent = (data.winRate || 0) + '%';
                    
                    const pnlElement = document.getElementById('totalPnL');
                    const pnl = parseFloat(data.totalPnL || 0);
                    pnlElement.textContent = '$' + pnl.toFixed(2);
                    pnlElement.className = 'metric-value ' + (pnl >= 0 ? 'text-success' : 'text-danger');
                    
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            }
        }

        // Initialize dashboard when page loads
        let dashboard;
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new CompleteTradingDashboard();
        });
    </script>
</body>
</html>
