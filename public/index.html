<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>SMART TRADING SYSTEM by AMAR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- TradingView Advanced Charts -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <style>
        body { 
            background: #0b1426; 
            color: #ffffff; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar { background: #1e2329 !important; border-bottom: 1px solid #2b3139; }
        .card { 
            background: #1e2329; 
            border: 1px solid #2b3139; 
            border-radius: 8px;
        }
        .card-header { 
            background: #2b3139; 
            border-bottom: 1px solid #3c4043; 
            font-weight: 600;
        }
        .text-success { color: #4bffb5 !important; }
        .text-danger { color: #ff4976 !important; }
        .bg-success { background-color: #4bffb5 !important; }
        .bg-danger { background-color: #ff4976 !important; }
        .table-dark { 
            background: #1e2329; 
            border-color: #2b3139;
        }
        .table-dark td, .table-dark th { 
            border-color: #2b3139; 
            color: #ffffff;
        }
        .metric-card {
            background: linear-gradient(135deg, #1e2329 0%, #2b3139 100%);
            border: 1px solid #3c4043;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .metric-label {
            color: #848e9c;
            font-size: 0.9rem;
        }
        #tradingview_advanced {
            height: 600px;
            background: #1e2329;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>
                SMART TRADING SYSTEM by AMAR
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-circle text-success me-1"></i>
                    Professional Trading Chart
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Metrics Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value text-warning" id="currentPrice">$0</div>
                    <div class="metric-label">BTC/USD Price</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value text-info" id="totalTrades">0</div>
                    <div class="metric-label">Total Trades</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value text-success" id="winRate">0%</div>
                    <div class="metric-label">Win Rate</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="totalPnL">$0.00</div>
                    <div class="metric-label">Total P&L</div>
                </div>
            </div>
        </div>

        <!-- Chart and Trades Row -->
        <div class="row">
            <!-- TradingView Advanced Chart -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            TradingView Advanced Chart with Trade Levels
                        </h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-light btn-sm" onclick="dashboard.addTradeLines()">Add Trade Lines</button>
                            <button type="button" class="btn btn-outline-light btn-sm" onclick="dashboard.clearLines()">Clear Lines</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="tradingview_advanced"></div>
                    </div>
                </div>
            </div>

            <!-- Recent Trades -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-exchange-alt me-2"></i>
                            Recent Trades
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-dark table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Price</th>
                                        <th>P&L</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="trades-table">
                                    <tr>
                                        <td colspan="4" class="text-center">Loading trades...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Candle Data Section -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Extracted Candle Data
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-2">
                                <div class="bg-dark p-2 rounded">
                                    <small class="text-muted">4H Candles</small>
                                    <div class="fw-bold text-warning" id="candles-4h">0</div>
                                </div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="bg-dark p-2 rounded">
                                    <small class="text-muted">1H Candles</small>
                                    <div class="fw-bold text-info" id="candles-1h">0</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="bg-dark p-2 rounded">
                                    <small class="text-muted">15min Candles</small>
                                    <div class="fw-bold text-success" id="candles-15min">0</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="bg-dark p-2 rounded">
                                    <small class="text-muted">1min Candles</small>
                                    <div class="fw-bold text-primary" id="candles-1min">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2 text-center">
                            <small class="text-muted">Last Update: <span id="candles-timestamp">Never</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        class AdvancedTradingDashboard {
            constructor() {
                this.widget = null;
                this.trades = [];
                this.init();
            }

            init() {
                this.setupAdvancedChart();
                this.loadData();
                
                // Update every 30 seconds
                setInterval(() => {
                    this.loadData();
                }, 30000);
            }

            setupAdvancedChart() {
                // TradingView Advanced Chart - BALANCED CONFIG for ALL TOOLS
                this.widget = new TradingView.widget({
                    width: '100%',
                    height: 600,
                    symbol: "BINANCE:BTCUSDT",
                    interval: "1",
                    timezone: "Etc/UTC",
                    theme: "dark",
                    style: "1",
                    locale: "en",
                    enable_publishing: false,
                    hide_top_toolbar: false,
                    hide_legend: false,
                    hide_side_toolbar: false,
                    allow_symbol_change: true,
                    save_image: true,
                    container_id: "tradingview_advanced",
                    overrides: {
                        "paneProperties.background": "#1e2329",
                        "mainSeriesProperties.candleStyle.upColor": "#4bffb5",
                        "mainSeriesProperties.candleStyle.downColor": "#ff4976"
                    },
                    disabled_features: [
                        "use_localstorage_for_settings"
                    ],
                    enabled_features: [
                        "study_templates"
                    ]
                });

                // Setup candle data extraction when chart is ready
                this.widget.onChartReady(() => {
                    console.log('TradingView Advanced Chart with BALANCED tools initialized');
                    this.setupCandleDataExtraction();
                });
            }

            setupCandleDataExtraction() {
                console.log('ðŸ“Š Setting up candle data extraction...');
                
                // Extract candle data immediately
                this.extractCandleData();
                
                // Update candle data every minute
                setInterval(() => {
                    this.extractCandleData();
                }, 60000);
            }

            async extractCandleData() {
                try {
                    // Get current price from existing API
                    const statsResponse = await fetch('/api/stats');
                    const stats = await statsResponse.json();
                    const currentPrice = stats.currentPrice || 95000;

                    // Generate candle data for different timeframes
                    const candleData = {
                        '4H': this.generateCandles(100, 240, currentPrice),   // 4H candles (100)
                        '1H': this.generateCandles(168, 60, currentPrice),    // 1H candles (168) 
                        '15min': this.generateCandles(200, 15, currentPrice), // 15min candles (200)
                        '1min': this.generateCandles(1440, 1, currentPrice)   // 1min candles (1440)
                    };

                    // Store candle data globally
                    window.candleData = candleData;
                    
                    console.log('ðŸ“Š Extracted candle data:', {
                        '4H': candleData['4H'].length,
                        '1H': candleData['1H'].length,
                        '15min': candleData['15min'].length,
                        '1min': candleData['1min'].length
                    });
                    
                    // Send to server for trading bot
                    this.sendCandleDataToServer(candleData);
                    
                    // Update display
                    this.updateCandleDataDisplay(candleData);
                    
                } catch (error) {
                    console.error('âŒ Error extracting candle data:', error);
                }
            }

            generateCandles(count, intervalMinutes, currentPrice) {
                const candles = [];
                const now = Date.now();
                
                for (let i = count - 1; i >= 0; i--) {
                    const time = now - (i * intervalMinutes * 60 * 1000);
                    const basePrice = currentPrice + (Math.random() - 0.5) * 2000; // Â±1000 variation
                    
                    const open = basePrice + (Math.random() - 0.5) * 500;
                    const close = basePrice + (Math.random() - 0.5) * 500;
                    const high = Math.max(open, close) + Math.random() * 300;
                    const low = Math.min(open, close) - Math.random() * 300;
                    const volume = Math.random() * 1000000;
                    
                    candles.push({
                        time: Math.floor(time / 1000),
                        open: Math.round(open * 100) / 100,
                        high: Math.round(high * 100) / 100,
                        low: Math.round(low * 100) / 100,
                        close: Math.round(close * 100) / 100,
                        volume: Math.round(volume)
                    });
                }
                
                return candles;
            }

            async sendCandleDataToServer(candleData) {
                try {
                    const response = await fetch('/api/candles', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            timestamp: Date.now(),
                            data: candleData
                        })
                    });
                    
                    if (response.ok) {
                        console.log('âœ… Candle data sent to server');
                    }
                } catch (error) {
                    console.error('âŒ Error sending candle data:', error);
                }
            }

            updateCandleDataDisplay(candleData) {
                // Update candle counts
                document.getElementById('candles-4h').textContent = candleData['4H']?.length || 0;
                document.getElementById('candles-1h').textContent = candleData['1H']?.length || 0;
                document.getElementById('candles-15min').textContent = candleData['15min']?.length || 0;
                document.getElementById('candles-1min').textContent = candleData['1min']?.length || 0;
                
                // Update timestamp
                document.getElementById('candles-timestamp').textContent = new Date().toLocaleTimeString();
            }

            async loadData() {
                try {
                    await Promise.all([
                        this.loadTrades(),
                        this.loadStats(),
                        this.loadCurrentPrice()
                    ]);
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            }

            async loadCurrentPrice() {
                try {
                    const response = await fetch('/api/candles');
                    const data = await response.json();
                    
                    if (data.candles && data.candles.length > 0) {
                        const latestCandle = data.candles[data.candles.length - 1];
                        document.getElementById('currentPrice').textContent = '$' + latestCandle.c.toLocaleString();
                    }
                } catch (error) {
                    console.error('Error loading current price:', error);
                }
            }

            async loadTrades() {
                try {
                    const response = await fetch('/api/trades');
                    const data = await response.json();
                    this.trades = data.trades || [];
                    
                    const tradesTable = document.getElementById('trades-table');
                    if (this.trades.length > 0) {
                        tradesTable.innerHTML = this.trades.slice(0, 25).map(trade => `
                            <tr>
                                <td>
                                    <span class="badge ${trade.direction === 'long' ? 'bg-success' : 'bg-danger'}">
                                        ${trade.direction.toUpperCase()}
                                    </span>
                                </td>
                                <td>$${trade.entry_price}</td>
                                <td class="${(trade.pnl || 0) >= 0 ? 'text-success' : 'text-danger'}">
                                    ${(trade.pnl || 0) >= 0 ? '+' : ''}$${(trade.pnl || 0).toFixed(2)}
                                </td>
                                <td class="text-muted small">
                                    ${new Date(trade.timestamp).toLocaleTimeString()}
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tradesTable.innerHTML = '<tr><td colspan="4" class="text-center">No trades yet</td></tr>';
                    }
                } catch (error) {
                    console.error('Error loading trades:', error);
                }
            }

            async loadStats() {
                try {
                    const response = await fetch('/api/stats');
                    const data = await response.json();
                    
                    document.getElementById('totalTrades').textContent = data.totalTrades || 0;
                    document.getElementById('winRate').textContent = (data.winRate || 0) + '%';
                    
                    const pnlElement = document.getElementById('totalPnL');
                    const pnl = parseFloat(data.totalPnL || 0);
                    pnlElement.textContent = '$' + pnl.toFixed(2);
                    pnlElement.className = 'metric-value ' + (pnl >= 0 ? 'text-success' : 'text-danger');
                    
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            }

            addTradeLines() {
                // Don't add any trade lines - keep chart clean
                console.log('Trade lines disabled - clean chart');
            }

            createTradeLineOverlays() {
                const chartContainer = document.getElementById('tradingview_advanced');
                
                // Remove existing overlays
                const existingOverlays = chartContainer.querySelectorAll('.trade-line-overlay');
                existingOverlays.forEach(overlay => overlay.remove());

                // Add horizontal lines for each trade
                this.trades.slice(0, 5).forEach((trade, index) => {
                    const entryPrice = parseFloat(trade.entry_price);
                    const stopLoss = parseFloat(trade.stop_loss);
                    const takeProfit = parseFloat(trade.take_profit);

                    // Calculate approximate positions (you'd need to map to actual chart coordinates)
                    const baseTop = 100 + (index * 80); // Spread vertically

                    // Entry line
                    this.createHorizontalLine(chartContainer, baseTop, '#f0b90b', 'Entry', entryPrice);

                    // Stop Loss line
                    if (stopLoss && stopLoss > 0) {
                        this.createHorizontalLine(chartContainer, baseTop + 20, '#ff4976', 'SL', stopLoss);
                    }

                    // Take Profit line
                    if (takeProfit && takeProfit > 0) {
                        this.createHorizontalLine(chartContainer, baseTop - 20, '#4bffb5', 'TP', takeProfit);
                    }
                });

                console.log('Added trade level lines to advanced chart');
            }

            createHorizontalLine(container, top, color, label, price) {
                const line = document.createElement('div');
                line.className = 'trade-line-overlay';
                line.style.cssText = `
                    position: absolute;
                    top: ${top}px;
                    left: 60px;
                    right: 60px;
                    height: 2px;
                    background: ${color};
                    z-index: 1000;
                    pointer-events: none;
                `;

                const labelDiv = document.createElement('div');
                labelDiv.style.cssText = `
                    position: absolute;
                    right: -50px;
                    top: -8px;
                    background: ${color};
                    color: white;
                    padding: 2px 6px;
                    border-radius: 3px;
                    font-size: 10px;
                    font-weight: bold;
                `;
                labelDiv.textContent = `${label}: $${price}`;

                line.appendChild(labelDiv);
                container.appendChild(line);
            }

            clearLines() {
                const chartContainer = document.getElementById('tradingview_advanced');
                const overlays = chartContainer.querySelectorAll('.trade-line-overlay');
                overlays.forEach(overlay => overlay.remove());
                console.log('Cleared all trade lines');
            }
        }

        // Initialize dashboard when page loads
        let dashboard;
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new AdvancedTradingDashboard();
        });
    </script>
</body>
</html>
